# 报告生成成本控制配置

> 🎯 **目标**: 单篇报告成本不超过 $0.8，同时保证报告质量

## 💰 成本控制策略

### 1. Token限制
```typescript
max_tokens: 18000  // 从20k降到18k，减少10%成本
```

**计算依据**:
- 预估总消耗: ~20,000 tokens (包含输入+输出+搜索)
- 成本计算: 20,000 × ($2.0/1M) = $0.04
- 安全边界: $0.8 ÷ $0.04 = 20倍安全余量

### 2. 实时监控
- ✅ **Token使用量监控**: 每次调用记录实际消耗
- ✅ **成本计算**: 基于 $2.0/百万tokens 实时计算
- ✅ **预警机制**: 超过 $0.8 时发出警告

### 3. 错误处理
- ✅ **网络超时**: 5分钟超时限制
- ✅ **连接失败**: 明确错误信息，避免重复调用
- ✅ **API错误**: 详细错误分类和处理

## 📊 成本预估表

| Token使用量 | 估算成本 | 状态 |
|-------------|----------|------|
| 15,000 | $0.030 | ✅ 理想 |
| 18,000 | $0.036 | ✅ 正常 |
| 25,000 | $0.050 | ⚠️ 偏高 |
| 400,000 | $0.800 | ❌ 预算上限 |

## 🛡️ 保护机制

### Token使用量监控
```typescript
const tokensUsed = data.usage?.total_tokens || 0
const estimatedCost = (tokensUsed / 1000000) * 2.0
console.log(`成本: $${estimatedCost.toFixed(4)}`)
if (estimatedCost > 0.8) {
  console.warn('⚠️ 超出预算限制')
}
```

### 网络错误处理
```typescript
const controller = new AbortController()
const timeoutId = setTimeout(() => controller.abort(), 300000)

try {
  response = await fetch(url, { signal: controller.signal })
} catch (fetchError) {
  if (fetchError.name === 'AbortError') {
    return { error: 'API请求超时' }
  }
  if (fetchError.message.includes('fetch failed')) {
    return { error: '网络连接失败' }
  }
}
```

## 🎯 质量保证

即使在成本控制下，确保报告质量：

### 内容要求
- ✅ 4个完整部分 (基本面、业务、增长、估值)
- ✅ 每部分最少500字
- ✅ 每部分2-3个数据表格
- ✅ JSON格式输出

### 优化策略
1. **精简System Prompt**: 移除冗余描述
2. **优化参数**: temperature=0.05, top_p=0.9
3. **限制搜索**: search_recency_filter='month'

## 📈 成本优化建议

### 短期优化 (立即生效)
- ✅ Token限制: 20k → 18k
- ✅ 超时控制: 5分钟限制
- ✅ 错误处理: 避免重复调用

### 中期优化 (1-2周)
- 🔄 **Prompt优化**: 精简系统提示词
- 🔄 **缓存机制**: 相同股票24小时内复用
- 🔄 **批量处理**: 多股票一次性分析

### 长期优化 (1个月+)
- 📊 **使用统计**: 分析用户使用模式
- 🎯 **分级服务**: 不同质量等级的报告
- 💰 **动态定价**: 根据成本调整用户定价

## ⚠️ 风险控制

### 成本风险
- **单用户限制**: 每日最多5篇报告
- **异常监控**: 单篇超过$0.5时人工审核
- **月度预算**: 总API成本不超过月预算50%

### 质量风险
- **最低标准**: 确保每部分至少500字
- **内容验证**: 检查4个部分是否都有实质内容
- **用户反馈**: 收集质量评价调整参数

---

**总结**: 通过18k token限制 + 实时监控 + 错误处理，可以将单篇报告成本控制在 $0.04 左右，远低于 $0.8 的预算限制，同时保证高质量输出。
